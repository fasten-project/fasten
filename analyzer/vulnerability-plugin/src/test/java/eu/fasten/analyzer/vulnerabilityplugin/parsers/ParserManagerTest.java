/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package eu.fasten.analyzer.vulnerabilityplugin.parsers;

import com.mongodb.client.MongoDatabase;
import eu.fasten.analyzer.vulnerabilityplugin.utils.PatchFarmer;
import eu.fasten.analyzer.vulnerabilityplugin.utils.Vulnerability;
import eu.fasten.analyzer.vulnerabilityplugin.utils.connections.JavaHttpClient;
import eu.fasten.analyzer.vulnerabilityplugin.utils.mappers.Severity;
import eu.fasten.analyzer.vulnerabilityplugin.utils.parsers.ExtraParser;
import eu.fasten.analyzer.vulnerabilityplugin.utils.parsers.GHParser;
import eu.fasten.analyzer.vulnerabilityplugin.utils.parsers.NVDParser;
import eu.fasten.analyzer.vulnerabilityplugin.utils.parsers.ParserManager;
import org.junit.Test;
import org.mockito.Mockito;

import java.util.HashMap;
import java.util.HashSet;

import static org.junit.Assert.assertEquals;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.mockito.Mockito.when;

public class ParserManagerTest {

    JavaHttpClient client = new JavaHttpClient();
    MongoDatabase dbMock = Mockito.mock(MongoDatabase.class);
    ParserManager pm = new ParserManager(client, dbMock, "<fake_token>");
    GHParser ghParserMock = Mockito.mock(GHParser.class);
    NVDParser nvdParserMock = Mockito.mock(NVDParser.class);
    ExtraParser extraParserMock = Mockito.mock(ExtraParser.class);
    PatchFarmer patchFarmerMock = Mockito.mock(PatchFarmer.class);

    @Test
    public void testMergingSources() {
        pm.injectParsers(nvdParserMock, ghParserMock, extraParserMock, patchFarmerMock);

        HashMap<String, Vulnerability> nvdVulns = new HashMap<>();
        Vulnerability v1 = new Vulnerability("CVE-TEST-1");
        Vulnerability v2 = new Vulnerability("CVE-TEST-2");
        v1.setScoreCVSS2(7.5);
        v1.addPatch("patch_1");
        v2.setDescription("Another Vulnerability");
        v2.addPurl("/pypi/django@1.0");

        nvdVulns.put(v1.getId(), v1);
        nvdVulns.put(v2.getId(), v2);

        HashMap<String, Vulnerability> ghVulns = new HashMap<>();
        Vulnerability v3 = new Vulnerability("CVE-TEST-1");
        Vulnerability v4 = new Vulnerability("CVE-TEST-2");
        Vulnerability v5 = new Vulnerability("CVE-TEST-3");
        v3.addPatch("patch_2");
        v4.addPurl("/pypi/django@2.0");
        v5.addReference("ref_1");

        ghVulns.put(v3.getId(), v3);
        ghVulns.put(v4.getId(), v4);
        ghVulns.put(v5.getId(), v5);

        HashMap<String, Vulnerability> extraVulns = new HashMap<>();
        Vulnerability v6 = new Vulnerability("CVE-TEST-1");
        Vulnerability v7 = new Vulnerability("CVE-TEST-3");
        Vulnerability v8 = new Vulnerability("CVE-TEST-4");
        v6.setSeverity(Severity.CRITICAL);
        v7.addReference("ref_1");

        extraVulns.put(v6.getId(), v6);
        extraVulns.put(v7.getId(), v7);
        extraVulns.put(v8.getId(), v8);

        when(nvdParserMock.getVulnerabilitiesFromNVD()).thenReturn(nvdVulns);
        when(ghParserMock.getVulnerabilitiesFromGH()).thenReturn(ghVulns);
        when(extraParserMock.getVulnerabilitiesFromExtraSources()).thenReturn(extraVulns);

        HashSet<Vulnerability> check = pm.getVulnerabilitiesFromParsers();
        // EXPECTED
        HashSet<Vulnerability> expected = new HashSet<>();
        Vulnerability vE1 = new Vulnerability("CVE-TEST-1");
        Vulnerability vE2 = new Vulnerability("CVE-TEST-2");
        Vulnerability vE3 = new Vulnerability("CVE-TEST-3");
        Vulnerability vE4 = new Vulnerability("CVE-TEST-4");

        // CVE-TEST-1
        vE1.setScoreCVSS2(7.5);
        vE1.addPatch("patch_1");
        vE1.addPatch("patch_2");
        vE1.setSeverity(Severity.CRITICAL);

        // CVE-TEST-2
        vE2.setDescription("Another Vulnerability");
        vE2.addPurl("/pypi/django@1.0");
        vE2.addPurl("/pypi/django@2.0");

        // CVE-TEST-3
        vE3.addReference("ref_1");

        expected.add(vE1);
        expected.add(vE2);
        expected.add(vE3);
        expected.add(vE4);

        assertTrue(expected.equals(check));
    }
}
